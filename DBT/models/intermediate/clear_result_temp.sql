{{
  config(
    materialized='table',
    alias='CLEARRESULTTEMP',
    schema='CLEAR'
  )
}}

SELECT IFNULL(A.CLEARDATE, B.CLEARDATE) AS CLEARDATE, -- 清分日期
    (CASE WHEN A.SPLITORG IS NOT NULL THEN A.SPLITORG ELSE B.SPLITORG END) AS SPLITORG, -- 小业主编码：长度2位-外省编码；长度4位-小业主编码
    IFNULL(A.CORP, B.CORP) CORP, -- 运营管理单位编码：长度2位-外省编码；长度6位-运营管理单位编码
    IFNULL(A.ROAD, B.ROAD) ROAD, -- 路段编码：长度2位-外省编码；长度6位-路段编码
    1 AS ORGTYPE,
    IFNULL(A.PAYCARDTYPE, B.PAYCARDTYPE) AS PAYCARDTYPE, -- 支付卡类型，现金交易填0
    0 AS MONEYFLAG, -- 0-现金、移动支付
    IFNULL(A.CASHSPLITMONEY, 0) AS CASHSPLITMONEY, -- 拆账   现金总收入
    IFNULL(A.CASHOPSPLITMONEY, 0) AS CASHOPSPLITMONEY, -- 拆账  现金外省代收收入
    IFNULL(B.CASHTOLLMONEY, 0) AS CASHTOLLMONEY, -- 通行费   现金总收入
    IFNULL(B.CASHOPTOLLMONEY, 0) AS CASHOPTOLLMONEY, -- 通行费   现金代外省收收入
    IFNULL(A.OTHERSPLITMONEY, 0) AS OTHERSPLITMONEY, -- 拆账   其他总收入
    IFNULL(A.OTHEROPSPLITMONEY, 0) AS OTHEROPSPLITMONEY, -- 拆账  其他外省代收收入
    IFNULL(B.OTHERTOLLMONEY, 0) AS OTHERTOLLMONEY, -- 通行费   其他总收入
    IFNULL(B.OTHEROPTOLLMONEY, 0) AS OTHEROPTOLLMONEY, -- 通行费   其他代外省收收入
    IFNULL(A.UNIONSPLITMONEY, 0) AS UNIONSPLITMONEY, -- 拆账   银联总收入
    IFNULL(A.UNIONOPSPLITMONEY, 0) AS UNIONOPSPLITMONEY, -- 拆账 银联外省代收收入
    IFNULL(B.UNIONTOLLMONEY, 0) AS UNIONTOLLMONEY, -- 通行费   银联总收入
    IFNULL(B.UNIONOPTOLLMONEY, 0) AS UNIONOPTOLLMONEY, -- 通行费   银联代外省收收入
    0 AS ETCSPLITMONEY, -- 拆账   ETC总收入
    0 AS ETCOPSPLITMONEY, -- 拆账  ETC外省代收收入
    0 AS ETCTOLLMONEY, -- 通行费   ETC总收入
    0 AS ETCOPTOLLMONEY, -- 通行费   ETC代外省收收入
    IFNULL(A.ALIPAYSPLITMONEY, 0) AS ALIPAYSPLITMONEY, -- 拆账   支付宝总收入
    IFNULL(A.ALIPAYOPSPLITMONEY, 0) AS ALIPAYOPSPLITMONEY, -- 拆账  支付宝外省代收收入
    IFNULL(B.ALIPAYTOLLMONEY, 0) AS ALIPAYTOLLMONEY, -- 通行费   支付宝总收入
    IFNULL(B.ALIPAYOPTOLLMONEY, 0) AS ALIPAYOPTOLLMONEY, -- 通行费   支付宝代外省收收入
    IFNULL(A.WEPAYSPLITMONEY, 0) AS WEPAYSPLITMONEY, -- 拆账   微信总收入
    IFNULL(A.WEPAYOPSPLITMONEY, 0) AS WEPAYOPSPLITMONEY, -- 拆账  微信外省代收收入
    IFNULL(B.WEPAYTOLLMONEY, 0) AS WEPAYTOLLMONEY, -- 通行费   微信总收入
    IFNULL(B.WEPAYOPTOLLMONEY, 0) AS WEPAYOPTOLLMONEY, -- 通行费   微信代外省收收入
    IFNULL(B.CASHRETURNMONEY, 0) CASHRETURNMONEY, IFNULL(B.OTHERRETURNMONEY, 0) OTHERRETURNMONEY, IFNULL(B.UNIONRETURNMONEY, 0) UNIONRETURNMONEY, IFNULL(B.ALIPAYRETURNMONEY, 0) ALIPAYRETURNMONEY, IFNULL(B.WEPAYRETURNMONEY, 0) WEPAYRETURNMONEY, -- 现金退费
    NOW() AS GENTIME -- 生成时间
FROM (
    SELECT CLEARDATE, PAYCARDTYPE, CASE WHEN SPLITORG IN('2701', '2702') THEN '7215' ELSE SPLITORG END SPLITORG, CASE WHEN CORP = '320000' THEN '570000' ELSE CORP END CORP, ROAD, SUM(CASHSPLITMONEY) CASHSPLITMONEY, SUM(CASHOPSPLITMONEY) CASHOPSPLITMONEY, -- 2025-05-20修改烟威公司下的清分结算数据归属到投资半岛公司（SPLITORG IN('2701','2702') THEN '7215'；CORP='320000' THEN '570000'）
        SUM(OTHERSPLITMONEY) OTHERSPLITMONEY, SUM(OTHEROPSPLITMONEY) OTHEROPSPLITMONEY, SUM(UNIONSPLITMONEY) UNIONSPLITMONEY, SUM(UNIONOPSPLITMONEY) UNIONOPSPLITMONEY,
        SUM(ALIPAYSPLITMONEY) ALIPAYSPLITMONEY, SUM(ALIPAYOPSPLITMONEY) ALIPAYOPSPLITMONEY, SUM(WEPAYSPLITMONEY) WEPAYSPLITMONEY, SUM(WEPAYOPSPLITMONEY) WEPAYOPSPLITMONEY,
        SUM(CASHRETURNMONEY) CASHRETURNMONEY, SUM(OTHERRETURNMONEY) OTHERRETURNMONEY, SUM(UNIONRETURNMONEY) UNIONRETURNMONEY, SUM(ALIPAYRETURNMONEY) ALIPAYRETURNMONEY, SUM(WEPAYRETURNMONEY) WEPAYRETURNMONEY
    FROM (
        SELECT CLEARDATE, PAYCARDTYPE,
            CASE WHEN LENGTH(TOLLSECTIONID) = 6 THEN SUBSTR(TOLLSECTIONID, 1, 2) ELSE (SELECT ROADID FROM TBL_GBSECTIONDIC WHERE ID = TOLLSECTIONID) END SPLITORG, -- LENGTH(TOLLSECTIONID)=6——外省通行方编码，截取前两位作为外省省中心编码；LENGTH(TOLLSECTIONID)!=6——拆分小业主的国标编码，转为小业主的省标
            CASE WHEN LENGTH(TOLLSECTIONID) = 6 THEN SUBSTR(TOLLSECTIONID, 1, 2) 
                 ELSE (SELECT CONCAT(T2.BL_ROAD, '0000') 
                       FROM TBL_GBSECTIONDIC T1, T_ORGCODE T2
                       WHERE T2.ORGCODE = CONCAT(T1.ROADID, '00') AND T2.ORGTYPE = 40 
                         AND T1.ID = TOLLSECTIONID 
                         AND T2.LASTVER = (SELECT MAX(LASTVER) FROM T_ORGCODE WHERE VERUSETIME < TIMESTAMP(CLEARDATE, '23:59:59') AND ORGTYPE = 40)) 
            END ROAD, -- LENGTH(TOLLSECTIONID)=6——外省通行方编码，截取前两位作为外省省中心编码；LENGTH(TOLLSECTIONID)!=6——根据拆分小业主查询对应的路段
            CASE WHEN LENGTH(TOLLSECTIONID) = 6 THEN SUBSTR(TOLLSECTIONID, 1, 2) 
                 ELSE (SELECT CONCAT(T2.BL_CORP, '0000') 
                       FROM TBL_GBSECTIONDIC T1, T_ORGCODE T2
                       WHERE T2.ORGCODE = CONCAT(T1.ROADID, '00') AND T2.ORGTYPE = 40 
                         AND T1.ID = TOLLSECTIONID 
                         AND T2.LASTVER = (SELECT MAX(LASTVER) FROM T_ORGCODE WHERE VERUSETIME < TIMESTAMP(CLEARDATE, '23:59:59') AND ORGTYPE = 40)) 
            END CORP, -- LENGTH(TOLLSECTIONID)=6——外省通行方编码，截取前两位作为外省省中心编码；LENGTH(TOLLSECTIONID)!=6——根据拆分小业主查询对应的运营管理单位
            SUM(CASE WHEN PAYTYPE = 1 THEN AMOUNT WHEN PAYTYPE = 0 THEN AMOUNT END) AS CASHSPLITMONEY, -- PAYTYPE=1——现金；PAYTYPE=0——外省代收（现金+移动支付）
            -- + SUM( CASE WHEN PAYTYPE=0 THEN AMOUNT END) AS CASHOPSPLITMONEY ,
            -- + SUM( CASE WHEN PAYTYPE=0 AND MODIFYFLAG=1 THEN AMOUNT WHEN MODIFYFLAG=2 AND LENGTH(EXTOLLSTATION)=2 AND LENGTH(TOLLSECTIONID)=11 THEN AMOUNT END) AS CASHOPSPLITMONEY ,--现金+移动支付的外省代收都放到CASHOPSPLITMONEY   外省代收的退费不能用PAYTYPE来区分
            SUM(CASE WHEN PROVINCETYPE = 2 THEN AMOUNT END) AS CASHOPSPLITMONEY, -- 现金+移动支付的外省代收都放到CASHOPSPLITMONEY   外省代收的退费不能用PAYTYPE来区分-------------11-30修改
            SUM(CASE WHEN PAYTYPE = 2 THEN AMOUNT END) AS OTHERSPLITMONEY, -- PAYTYPE=2——其他
            0 AS OTHEROPSPLITMONEY, -- 外省代收已放到CASHOPSPLITMONEY
            SUM(CASE WHEN PAYTYPE = 3 THEN AMOUNT END) AS UNIONSPLITMONEY, -- PAYTYPE=3——银联
            0 AS UNIONOPSPLITMONEY, -- 外省代收已放到CASHOPSPLITMONEY
            SUM(CASE WHEN PAYTYPE = 6 THEN AMOUNT END) AS ALIPAYSPLITMONEY, -- PAYTYPE=5——支付宝-------------11-30修改
            0 AS ALIPAYOPSPLITMONEY, -- 外省代收已放到CASHOPSPLITMONEY
            SUM(CASE WHEN PAYTYPE = 7 THEN AMOUNT END) AS WEPAYSPLITMONEY, -- PAYTYPE=6——微信-------------11-30修改
            0 AS WEPAYOPSPLITMONEY, -- 外省代收已放到CASHOPSPLITMONEY
            0 CASHRETURNMONEY, 0 OTHERRETURNMONEY, 0 UNIONRETURNMONEY, 0 ALIPAYRETURNMONEY, 0 WEPAYRETURNMONEY -- 现金退费
        FROM TBL_EXCLEARRESULTCASH
        WHERE CLEARDATE = '2025-01-08' AND ROADTYPE = 1 -- ROADTYPE=1——高速公路
        GROUP BY TOLLSECTIONID, PAYCARDTYPE, CLEARDATE
    ) SUB1
    GROUP BY CASE WHEN SPLITORG IN('2701', '2702') THEN '7215' ELSE SPLITORG END, PAYCARDTYPE, CLEARDATE, ROAD, CASE WHEN CORP = '320000' THEN '570000' ELSE CORP END
) A
LEFT JOIN (
    SELECT CLEARDATE, PAYCARDTYPE, CASE WHEN LENGTH(SPLITORG) = 6 THEN SUBSTR(SPLITORG, 1, 2) WHEN SPLITORG IN('2701', '2702') THEN '7215' ELSE SPLITORG END SPLITORG, ROAD, CASE WHEN CORP = '320000' THEN '570000' ELSE CORP END CORP, SUM(CASHTOLLMONEY) CASHTOLLMONEY, SUM(CASHOPTOLLMONEY) CASHOPTOLLMONEY, SUM(OTHERTOLLMONEY) OTHERTOLLMONEY,
        SUM(OTHEROPTOLLMONEY) OTHEROPTOLLMONEY, SUM(UNIONTOLLMONEY) UNIONTOLLMONEY, SUM(UNIONOPTOLLMONEY) UNIONOPTOLLMONEY, SUM(ALIPAYTOLLMONEY) ALIPAYTOLLMONEY,
        SUM(ALIPAYOPTOLLMONEY) ALIPAYOPTOLLMONEY, SUM(WEPAYTOLLMONEY) WEPAYTOLLMONEY, SUM(WEPAYOPTOLLMONEY) WEPAYOPTOLLMONEY,
        SUM(CASHRETURNMONEY) CASHRETURNMONEY, SUM(OTHERRETURNMONEY) OTHERRETURNMONEY, SUM(UNIONRETURNMONEY) UNIONRETURNMONEY, SUM(ALIPAYRETURNMONEY) ALIPAYRETURNMONEY, SUM(WEPAYRETURNMONEY) WEPAYRETURNMONEY
    FROM (
        SELECT CLEARDATE, PAYCARDTYPE,
            CASE WHEN LENGTH(EXTOLLSTATION) = 2 THEN EXTOLLSTATION 
                 ELSE (SELECT T2.BL_OWNER 
                       FROM T_ORGCODE T1, T_ORGCODE T2
                       WHERE T2.ORGCODE = CONCAT(T1.BL_SUBCENTER, '00') AND T2.ORGTYPE = 22
                         AND T1.ORGCODE = EXTOLLSTATION AND T1.ORGTYPE = 23
                         AND T1.LASTVER = (SELECT MAX(LASTVER) FROM T_ORGCODE WHERE VERUSETIME < TIMESTAMP(CLEARDATE, '23:59:59') AND ORGTYPE = 23)
                         AND T2.LASTVER = (SELECT MAX(LASTVER) FROM T_ORGCODE WHERE VERUSETIME < TIMESTAMP(CLEARDATE, '23:59:59') AND ORGTYPE = 22)) 
            END SPLITORG, -- 根据EXTOLLSTATION查收费小业主
            CASE WHEN LENGTH(EXTOLLSTATION) = 2 THEN EXTOLLSTATION 
                 ELSE (SELECT CONCAT(BL_ROAD, '0000') FROM T_ORGCODE WHERE ORGTYPE = 23 AND LASTVER = (SELECT MAX(LASTVER) FROM T_ORGCODE WHERE VERUSETIME < TIMESTAMP(CLEARDATE, '23:59:59') AND ORGTYPE = 23) AND ORGCODE = EXTOLLSTATION) 
            END ROAD, -- 根据EXTOLLSTATION查收费路段
            CASE WHEN LENGTH(EXTOLLSTATION) = 2 THEN EXTOLLSTATION 
                 ELSE (SELECT CONCAT(BL_CORP, '0000') FROM T_ORGCODE WHERE ORGTYPE = 23 AND LASTVER = (SELECT MAX(LASTVER) FROM T_ORGCODE WHERE VERUSETIME < TIMESTAMP(CLEARDATE, '23:59:59') AND ORGTYPE = 23) AND ORGCODE = EXTOLLSTATION) 
            END CORP, -- 根据EXTOLLSTATION查收费运营管理单位
            SUM(CASE WHEN PAYTYPE = 1 THEN AMOUNT WHEN PAYTYPE = 0 THEN AMOUNT END) AS CASHTOLLMONEY,
            SUM(CASE WHEN PAYTYPE = 1 AND LENGTH(TOLLSECTIONID) = 6 THEN AMOUNT END) AS CASHOPTOLLMONEY,
            SUM(CASE WHEN PAYTYPE = 2 THEN AMOUNT END) AS OTHERTOLLMONEY, -- PAYTYPE=2——其他
            SUM(CASE WHEN PAYTYPE = 2 AND LENGTH(TOLLSECTIONID) = 6 THEN AMOUNT END) AS OTHEROPTOLLMONEY,
            SUM(CASE WHEN PAYTYPE = 3 THEN AMOUNT END) AS UNIONTOLLMONEY,
            SUM(CASE WHEN PAYTYPE = 3 AND LENGTH(TOLLSECTIONID) = 6 THEN AMOUNT END) AS UNIONOPTOLLMONEY,
            SUM(CASE WHEN PAYTYPE = 6 THEN AMOUNT END) AS ALIPAYTOLLMONEY,
            SUM(CASE WHEN PAYTYPE = 6 AND LENGTH(TOLLSECTIONID) = 6 THEN AMOUNT END) AS ALIPAYOPTOLLMONEY,
            SUM(CASE WHEN PAYTYPE = 7 THEN AMOUNT END) AS WEPAYTOLLMONEY,
            SUM(CASE WHEN PAYTYPE = 7 AND LENGTH(TOLLSECTIONID) = 6 THEN AMOUNT END) AS WEPAYOPTOLLMONEY,
            SUM(CASE WHEN PAYTYPE = 1 AND MODIFYFLAG = 2 AND PROVINCETYPE = 1 AND LENGTH(TOLLSECTIONID) = 6 THEN -AMOUNT END) CASHRETURNMONEY, -- 现金退费
            SUM(CASE WHEN PAYTYPE = 2 AND MODIFYFLAG = 2 AND PROVINCETYPE = 1 AND LENGTH(TOLLSECTIONID) = 6 THEN -AMOUNT END) OTHERRETURNMONEY, -- 其他退费
            SUM(CASE WHEN PAYTYPE = 3 AND MODIFYFLAG = 2 AND PROVINCETYPE = 1 AND LENGTH(TOLLSECTIONID) = 6 THEN -AMOUNT END) UNIONRETURNMONEY, -- 银联退费
            SUM(CASE WHEN PAYTYPE = 6 AND MODIFYFLAG = 2 AND PROVINCETYPE = 1 AND LENGTH(TOLLSECTIONID) = 6 THEN -AMOUNT END) ALIPAYRETURNMONEY, -- 支付宝退费
            SUM(CASE WHEN PAYTYPE = 7 AND MODIFYFLAG = 2 AND PROVINCETYPE = 1 AND LENGTH(TOLLSECTIONID) = 6 THEN -AMOUNT END) WEPAYRETURNMONEY -- 微信退费
        FROM TBL_EXCLEARRESULTCASH
        WHERE CLEARDATE = '2025-01-08' AND ROADTYPE = 1
        GROUP BY SECTIONID, PAYCARDTYPE, CLEARDATE, TOLLSTATION, EXTOLLSTATION
    ) SUB2
    GROUP BY CASE WHEN LENGTH(SPLITORG) = 6 THEN SUBSTR(SPLITORG, 1, 2) WHEN SPLITORG IN('2701', '2702') THEN '7215' ELSE SPLITORG END, PAYCARDTYPE, CLEARDATE, ROAD, CASE WHEN CORP = '320000' THEN '570000' ELSE CORP END
) B ON A.SPLITORG = B.SPLITORG AND A.PAYCARDTYPE = B.PAYCARDTYPE AND A.CLEARDATE = B.CLEARDATE AND A.ROAD = B.ROAD AND A.CORP = B.CORP
