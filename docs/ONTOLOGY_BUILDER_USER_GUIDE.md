# 本体构建工具使用说明与逻辑分析

## 目录

1. [功能概述](#功能概述)
2. [快速开始](#快速开始)
3. [核心功能详解](#核心功能详解)
4. [工作空间集成](#工作空间集成)
5. [版本管理](#版本管理)
6. [使用流程](#使用流程)
7. [常见问题](#常见问题)

---

## 功能概述

本体构建工具（Ontology Builder）是一个可视化本体建模工具，支持：

- ✅ **可视化建模**：通过拖拽和连线创建实体和关系
- ✅ **版本历史管理**：自动保存版本快照，支持版本对比和回滚
- ✅ **工作空间集成**：自动关联当前工作空间，统一管理
- ✅ **语义化版本**：支持 MAJOR.MINOR.PATCH 版本规范
- ✅ **自动校验**：前后端双重校验机制

---

## 快速开始

### 1. 准备工作空间

在开始创建本体模型之前，建议先选择或创建工作空间：

1. 在左侧导航栏顶部，点击工作空间下拉菜单
2. 选择已存在的工作空间，或点击"创建工作空间"创建新的
3. 工作空间用于对对象类型和关系类型进行分组管理

**重要**：选择工作空间后，保存的模型会自动关联到该工作空间。

### 2. 创建模型

1. 打开"本体构建工具"页面
2. 点击"添加实体"按钮创建实体节点
3. 拖拽节点连接线创建关系
4. 在右侧属性面板编辑实体和关系的详细信息

### 3. 保存模型

1. 点击"生成并校验"按钮
2. 检查校验结果（错误和警告）
3. 输入文件名（不含扩展名）
4. （可选）输入提交说明
5. 点击"导入系统内"保存

---

## 核心功能详解

### 一、可视化建模

#### 1.1 创建实体

**操作步骤**：
1. 点击画布左上角的"添加实体"按钮
2. 在画布上会出现一个新的实体节点
3. 点击节点，在右侧属性面板编辑实体信息

**实体属性配置**：
- **名称**（必填）：实体唯一标识，如 `User`、`Order`
- **显示名称**（可选）：中文显示名称，如 `用户`、`订单`
- **描述**（可选）：实体用途说明
- **基础类型**（可选）：继承自其他实体
- **属性列表**：定义实体的属性字段

**属性配置**：
- **名称**：属性名称，如 `id`、`name`、`email`
- **类型**：数据类型（string、number、boolean、date 等）
- **必填**：是否必填字段
- **唯一**：是否唯一约束
- **默认值**：默认值
- **约束**：其他约束条件

#### 1.2 创建关系

**操作步骤**：
1. 将鼠标悬停在源实体节点上
2. 拖拽连接点到目标实体节点
3. 松开鼠标创建关系
4. 点击关系连线，在右侧属性面板编辑关系信息

**关系属性配置**：
- **名称**（必填）：关系唯一标识，如 `hasOrder`、`belongsTo`
- **显示名称**（可选）：中文显示名称
- **关系类型**：
  - `1-1`：一对一
  - `1-N`：一对多
  - `N-1`：多对一
  - `N-N`：多对多
- **方向**：有向或无向
- **属性映射**：配置源实体和目标实体之间的属性映射关系
- **关系属性**：关系本身的属性（可选）

#### 1.3 编辑和删除

- **编辑**：点击节点或连线，在右侧属性面板修改
- **删除**：选中节点或连线后，点击右侧属性面板的删除按钮

---

### 二、工作空间集成

#### 2.1 工作空间的作用

工作空间用于：
- **分组管理**：将相关的对象类型和关系类型组织在一起
- **权限控制**：不同工作空间可以有不同的访问权限（未来功能）
- **模型关联**：本体模型自动关联到当前选中的工作空间

#### 2.2 工作空间状态显示

在顶部工具栏中，如果已选择工作空间，会显示：

```
工作空间: [工作空间名称]
```

如果未选择工作空间，保存时会显示警告提示。

#### 2.3 自动关联机制

**保存时自动关联**：
- 系统会自动读取当前选中的工作空间ID
- 保存模型时，工作空间信息会自动写入版本元数据
- 无需手动输入工作空间信息

**版本历史中显示**：
- 在版本历史对话框中，每个版本都会显示关联的工作空间信息
- 可以追溯模型在不同工作空间中的变更历史

---

### 三、版本管理

#### 3.1 版本号规范

**语义化版本格式**：`MAJOR.MINOR.PATCH`

- **MAJOR**（主版本号）：不兼容的API修改
- **MINOR**（次版本号）：向下兼容的功能性新增
- **PATCH**（修订号）：向下兼容的问题修正

**示例**：
- `1.0.0` - 初始版本
- `1.0.1` - 修复小问题
- `1.1.0` - 新增功能
- `2.0.0` - 重大变更

#### 3.2 自动版本递增

**规则**：
1. 如果版本号为空，系统会自动从上一版本递增 PATCH 版本
2. 如果不存在历史版本，默认使用 `1.0.0`
3. 可以手动指定版本号（覆盖自动递增）

**示例**：
- 首次保存：`1.0.0`
- 第二次保存（未指定版本）：`1.0.1`
- 手动指定 `2.0.0`：使用 `2.0.0`

#### 3.3 版本历史管理

**查看版本历史**：

1. 输入文件名后，点击"版本历史"按钮
2. 在弹出的对话框中查看所有版本列表

**版本信息显示**：
- **版本号**：如 `v1.0.0`、`v1.1.0`
- **提交时间**：版本保存的时间
- **提交说明**：用户输入的提交说明
- **工作空间**：关联的工作空间名称
- **变更摘要**：自动计算的变更内容

**变更摘要包括**：
- 对象类型变更数量
- 关系类型变更数量
- 元数据变更（命名空间、版本号等）

#### 3.4 版本对比

**功能说明**：
- 系统会自动对比当前版本与上一版本的差异
- 对比结果保存在版本元数据中
- 可以通过 API 调用进行详细对比

**对比内容**：
- **对象类型**：新增、修改、删除的对象类型
- **关系类型**：新增、修改、删除的关系类型
- **属性**：属性的增删改
- **元数据**：命名空间、版本号等变更

#### 3.5 版本回滚

**功能说明**：
- 支持回滚到任意历史版本
- 回滚会创建新版本（不会覆盖历史版本）

**使用方式**：
- 通过 API 调用 `rollback()` 方法
- 传入文件名和目标版本号

---

## 使用流程

### 完整工作流程

```
1. 选择工作空间
   ↓
2. 创建实体和关系
   ↓
3. 配置属性
   ↓
4. 生成并校验
   ↓
5. 输入文件名和提交说明
   ↓
6. 保存到系统
   ↓
7. 查看版本历史
```

### 详细步骤

#### 步骤 1：选择工作空间

**位置**：左侧导航栏顶部

**操作**：
1. 点击工作空间下拉菜单
2. 选择已存在的工作空间
3. 或点击"创建工作空间"创建新的

**提示**：
- 工作空间选择后会自动保存到本地存储
- 下次打开页面时会自动恢复选择

#### 步骤 2：创建模型

**创建实体**：
1. 点击"添加实体"按钮
2. 在右侧属性面板填写实体信息
3. 添加属性字段

**创建关系**：
1. 拖拽实体节点之间的连接线
2. 在右侧属性面板配置关系信息
3. 设置关系类型和方向

#### 步骤 3：生成并校验

**操作**：
1. 点击顶部工具栏的"生成并校验"按钮
2. 系统会进行前后端双重校验
3. 查看校验结果（错误和警告）

**校验内容**：
- **结构校验**：必填字段、格式、唯一性
- **语义校验**：实体引用、关系自环、关系唯一性
- **完整性校验**：主键检查、属性重复、孤立实体

#### 步骤 4：保存模型

**操作**：
1. 在底部校验结果区域，输入文件名
2. （可选）输入提交说明
3. 确认工作空间信息（自动显示）
4. 点击"导入系统内"按钮

**保存结果**：
- 文件保存到 `ontology/models/{filename}/` 目录
- 创建版本快照
- 保存版本元数据
- 关联工作空间信息

#### 步骤 5：查看版本历史

**操作**：
1. 输入文件名后，点击"版本历史"按钮
2. 查看所有版本列表
3. 每个版本显示详细信息

**版本信息**：
- 版本号
- 提交时间
- 提交说明
- 工作空间
- 变更摘要

---

## 逻辑分析

### 一、版本存储逻辑

#### 1.1 目录结构

```
ontology/
├── models/                    # 模型文件目录
│   ├── model1.yaml           # 当前版本（最新）
│   └── model1/               # 版本历史目录
│       ├── metadata.json     # 版本元数据
│       ├── v1_0_0.yaml       # 版本快照
│       ├── v1_0_1.yaml
│       └── v1_1_0.yaml
└── model1.yaml               # 向后兼容（主文件）
```

#### 1.2 版本元数据

**metadata.json 结构**：
```json
{
  "versions": [
    {
      "version": "1.0.0",
      "namespace": "ontology.builder",
      "filename": "model1",
      "file_path": "ontology/models/model1/v1_0_0.yaml",
      "previous_version": null,
      "commit_message": "初始版本",
      "workspace_id": "workspace-123",
      "workspace_name": "默认工作空间",
      "timestamp": 1704067200000,
      "changes": ["初始版本"]
    }
  ]
}
```

#### 1.3 版本保存流程

```
1. 校验模型
   ↓
2. 获取当前版本（如果存在）
   ↓
3. 确定新版本号（自动递增或用户指定）
   ↓
4. 保存版本快照到版本目录
   ↓
5. 计算变更摘要（对比上一版本）
   ↓
6. 保存版本元数据
   ↓
7. 更新当前版本链接
   ↓
8. 更新主文件（向后兼容）
```

### 二、工作空间关联逻辑

#### 2.1 关联机制

**前端**：
- 使用 `useWorkspace()` Hook 获取当前选中的工作空间
- 保存时自动传递 `selectedWorkspaceId` 到后端

**后端**：
- 接收 `workspaceId` 参数
- 保存到版本元数据中
- 可选参数，不影响未关联工作空间的保存

#### 2.2 工作空间信息显示

**顶部工具栏**：
- 如果已选择工作空间，显示工作空间名称
- 如果未选择，保存时显示警告提示

**版本历史**：
- 每个版本显示关联的工作空间名称
- 可以追溯模型在不同工作空间中的变更

### 三、版本对比逻辑

#### 3.1 对比算法

**对象类型对比**：
1. 构建名称映射表
2. 查找新增的对象类型
3. 查找删除的对象类型
4. 对比修改的对象类型（属性、描述等）

**关系类型对比**：
1. 使用 `name::source_type::target_type` 作为唯一键
2. 查找新增、删除、修改的关系类型

**属性对比**：
1. 对比属性名称、类型、约束等
2. 识别新增、删除、修改的属性

#### 3.2 变更摘要生成

**自动计算**：
- 对象类型变更数量
- 关系类型变更数量
- 元数据变更（命名空间、版本号）

**保存时机**：
- 保存新版本时自动计算
- 对比当前版本与上一版本
- 结果保存在版本元数据中

### 四、自动版本递增逻辑

#### 4.1 版本号解析

**支持格式**：
- `1.0.0` - 标准格式
- `1.0` - 简化格式（自动补全为 `1.0.0`）
- `1` - 简化格式（自动补全为 `1.0.0`）

**解析规则**：
- 使用正则表达式解析版本号
- 提取 MAJOR、MINOR、PATCH 部分
- 支持预发布标识（如 `1.0.0-alpha`）

#### 4.2 递增规则

**默认递增**：
- 如果版本号为空，自动递增 PATCH 版本
- 如果不存在历史版本，使用 `1.0.0`

**手动指定**：
- 用户可以在版本号输入框中手动指定版本号
- 手动指定的版本号会覆盖自动递增

**示例**：
```
首次保存：1.0.0（默认）
第二次保存（未指定）：1.0.1（自动递增 PATCH）
手动指定 2.0.0：2.0.0（使用指定版本）
第三次保存（未指定）：2.0.1（从 2.0.0 递增）
```

---

## 常见问题

### Q1: 如何查看版本历史？

**A**: 
1. 输入文件名
2. 点击"版本历史"按钮
3. 在弹出的对话框中查看所有版本

### Q2: 版本号如何自动递增？

**A**: 
- 如果版本号输入框为空，系统会自动从上一版本递增 PATCH 版本
- 如果不存在历史版本，默认使用 `1.0.0`
- 可以手动指定版本号覆盖自动递增

### Q3: 工作空间如何关联？

**A**: 
- 系统会自动读取当前选中的工作空间
- 保存时自动关联，无需手动输入
- 如果未选择工作空间，保存时会显示警告，但不会阻止保存

### Q4: 如何回滚到历史版本？

**A**: 
- 目前需要通过 API 调用 `rollback()` 方法
- 未来版本会在 UI 中添加回滚按钮

### Q5: 版本对比功能如何使用？

**A**: 
- 系统会自动对比当前版本与上一版本
- 对比结果保存在版本元数据中
- 可以通过 API 调用进行详细对比

### Q6: 文件保存在哪里？

**A**: 
- 主文件：`ontology/{filename}.yaml`（向后兼容）
- 当前版本：`ontology/models/{filename}.yaml`
- 版本快照：`ontology/models/{filename}/v{version}.yaml`
- 版本元数据：`ontology/models/{filename}/metadata.json`

### Q7: 如何修改已保存的模型？

**A**: 
1. 使用"加载文件"功能加载已保存的模型
2. 进行修改
3. 重新生成并校验
4. 保存时会创建新版本（不会覆盖历史版本）

### Q8: 提交说明是必填的吗？

**A**: 
- 不是必填的，但建议填写
- 提交说明有助于理解版本变更内容
- 会在版本历史中显示

---

## 最佳实践

### 1. 版本号管理

- **初始版本**：使用 `1.0.0`
- **小修复**：递增 PATCH 版本（如 `1.0.1`）
- **新功能**：递增 MINOR 版本（如 `1.1.0`）
- **重大变更**：递增 MAJOR 版本（如 `2.0.0`）

### 2. 提交说明

- **清晰描述**：简要说明本次变更的内容
- **变更类型**：如"新增用户实体"、"修复关系映射"等
- **关联需求**：可以关联需求编号或任务编号

### 3. 工作空间使用

- **按项目分组**：不同项目使用不同工作空间
- **按模块分组**：大型项目可以按模块划分工作空间
- **统一管理**：相关模型保存在同一工作空间

### 4. 模型命名

- **文件名**：使用有意义的名称，如 `user-model`、`order-system`
- **命名空间**：使用点分隔的层级结构，如 `com.company.ontology`
- **版本号**：遵循语义化版本规范

---

## 技术细节

### API 接口

#### 保存模型
```
POST /api/v1/ontology-builder/save?filename={filename}&workspaceId={id}&commitMessage={msg}
```

#### 获取版本历史
```
GET /api/v1/ontology-builder/versions/{filename}/history
```

#### 获取指定版本
```
GET /api/v1/ontology-builder/versions/{filename}/{version}
```

#### 对比版本
```
POST /api/v1/ontology-builder/versions/{filename}/compare
Body: { "version1": "1.0.0", "version2": "1.1.0" }
```

#### 回滚版本
```
POST /api/v1/ontology-builder/versions/{filename}/rollback?version={version}
```

---

## 总结

本体构建工具提供了完整的版本管理和工作空间集成功能：

✅ **版本历史管理**：自动保存版本快照，支持查看和回滚
✅ **工作空间集成**：自动关联当前工作空间，统一管理
✅ **版本对比**：自动对比版本差异，生成变更摘要
✅ **语义化版本**：支持标准版本规范，自动递增
✅ **用户友好**：清晰的UI提示，简单易用

通过合理使用这些功能，可以更好地管理本体模型的版本变更，提高开发效率。

